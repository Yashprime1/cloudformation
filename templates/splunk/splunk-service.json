{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Parameters":{
        "RegionPrefix":{
            "Type":"String",
            "Default":""
        }
    },
    "Resources":{
        "IrisTaskExecutionIamRole":{
            "Type":"AWS::IAM::Role",
            "Properties":{
                "AssumeRolePolicyDocument":{
                    "Version":"2012-10-17",
                    "Statement":[
                        {
                            "Effect":"Allow",
                            "Principal":{
                                "Service":[
                                    "ecs-tasks.amazonaws.com"
                                ]
                            },
                            "Action":[
                                "sts:AssumeRole"
                            ]
                        }
                    ]
                },
                "Path":"/"
            }
        },
        "IrisTaskIamRole":{
            "Type":"AWS::IAM::Role",
            "Properties":{
                "AssumeRolePolicyDocument":{
                    "Version":"2012-10-17",
                    "Statement":[
                        {
                            "Effect":"Allow",
                            "Principal":{
                                "Service":[
                                    "ecs-tasks.amazonaws.com"
                                ]
                            },
                            "Action":[
                                "sts:AssumeRole"
                            ]
                        }
                    ]
                },
                "Path":"/"
            }
        },
        "IrisTaskExecutionIamPolicy":{
            "Type":"AWS::IAM::Policy",
            "Properties":{
                "PolicyName":"IrisTaskExecutionIamPolicy",
                "PolicyDocument":{
                    "Version":"2012-10-17",
                    "Statement":[
                        {
                            "Effect":"Allow",
                            "Action":[
                                "logs:CreateLogStream",
                                "logs:PutLogEvents"
                            ],
                            "Resource":"arn:aws:logs:*:*:*"
                        }
                    ]
                },
                "Roles":[
                    {"Ref":"IrisTaskExecutionIamRole"}
                ]
            }
        },
        "IrisTaskIamPolicy":{
            "Type":"AWS::IAM::Policy",
            "Properties":{
                "PolicyName":"IrisTaskIamPolicy",
                "PolicyDocument":{
                    "Version":"2012-10-17",
                    "Statement":[
                        {
                            "Effect":"Allow",
                            "Action":[
                                "ec2:DescribeNetworkInterfaces",
                                "ec2:CreateNetworkInterface",
                                "ec2:DeleteNetworkInterface",
                                "ec2:DescribeSubnets",
                                "ec2:DescribeSecurityGroups",
                                "ec2:DescribeInstances",
                                "ec2:AttachNetworkInterface",
                                "ec2:DetachNetworkInterface"
                            ],
                            "Resource":"*"
                        }
                    ]
                },
                "Roles":[
                    {"Ref":"IrisTaskIamRole"}
                ]
            }
        },
        "IrisTaskDefinition":{
            "Type":"AWS::ECS::TaskDefinition",
            "Properties":{
                "ContainerDefinitions":[
                    {
                        "Name":"Iris",
                        "Image":"yashprime07/dream-saprx:latest",
                        "Cpu":512,
                        "Environment":[
                            {
                                "Name":"Friend",
                                "Value":"Iris"
                            }
                        ],
                        "Essential":"true",
                        "Memory":512
                    }
                ],
                "NetworkMode" : "awsvpc",
                "RequiresCompatibilities": [
                    "EC2"
                ],
                "Tags":[
                    {
                        "Key":"Name",
                        "Value":"Iris"
                    },
                    {
                        "Key":"Task Definition Name",
                        "Value":{"Fn::Join":["-",[{"Ref":"RegionPrefix"},"IrisTaskDefinition"]]}
                    }
                ],
                "ExecutionRoleArn":{"Fn::GetAtt":["IrisTaskExecutionIamRole","Arn"] },
                "TaskRoleArn":{"Fn::GetAtt":["IrisTaskIamRole","Arn"]}
            }
        },
        "IrisEcsCluster":{
            "Type":"AWS::ECS::Cluster",
            "Properties":{
                "Tags":[
                    {
                        "Key":"Name",
                        "Value":"Iris"
                    },
                    {
                        "Key":"Cluster Name",
                        "Value":{"Fn::Join":["-",[{"Ref":"RegionPrefix"},"IrisEcsCluster"]]}
                    }
                ]
            }
        },
        "IrisEcsService":{
            "Type":"AWS::ECS::Service",
            "Properties":{
                "Cluster":{"Ref":"IrisEcsCluster"},
                "DeploymentConfiguration":{
                    "MaximumPercent":100,
                    "MinimumHealthyPercent":0
                },
                "DeploymentController":{
                    "Type":"ECS"
                },
                "EnableECSManagedTags":"true",
                "EnableExecuteCommand":"true",     
                "DesiredCount":1,
                "LaunchType":"EC2",
                "SchedulingStrategy":"REPLICA",
                "ServiceName":{"Fn::Join":["-",[{"Ref":"RegionPrefix"},"IrisEcsService"]]},
                "TaskDefinition":{"Ref":"IrisTaskDefinition"},
                "NetworkConfiguration":{
                    "AwsvpcConfiguration" :{
                        "SecurityGroups" : [
                            { 
                                "Fn::ImportValue":{
                                    "Fn::Join":[
                                        "-",
                                        [
                                            {
                                                "Ref":"RegionPrefix"
                                            },
                                            "IRISInstanceSecurityGroupId"
                                        ]
                                    ]
                                }
                            }
                        ],
                        "Subnets" : [ 
                            {
                                "Fn::ImportValue": 
                                    {
                                        "Fn::Sub": "${RegionPrefix}-public-subnet-1-id"
                                    }
                            },
                            {
                                "Fn::ImportValue": 
                                    {
                                        "Fn::Sub": "${RegionPrefix}-public-subnet-2-id"
                                    }
                            },
                            {
                                "Fn::ImportValue": 
                                    {
                                        "Fn::Sub": "${RegionPrefix}-public-subnet-3-id"
                                    }
                            }
                        ]
                      }
                },
                "LoadBalancer":[
                    {
                        "ContainerName":"Iris",
                        "ContainerPort":3000,
                        "TargetGroupArn":{
                            "Fn::ImportValue":{
                                "Fn::Join":
                                    ["-",
                                        [
                                            {
                                                "Ref":"RegionPrefix"
                                            },
                                            "IrisTargetGroupArn"
                                        ]
                                    ]
                                }
                        }
                    }
                ],
                "Tags":[
                    {
                        "Key":"Name",
                        "Value":"Iris"
                    },
                    {
                        "Key":"Service Name",
                        "Value":{"Fn::Join":["-",[{"Ref":"RegionPrefix"},"IrisEcsService"]]}
                    }
                ]
            }
        }
    }
}