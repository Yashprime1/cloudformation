{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Parameters":{
        "VpcCidrPrefix":{
            "Type":"String",
            "Default":""
        },
        "RegionPrefix":{
            "Type":"String",
            "Default":""
        }
    },
    "Mappings": {
        "AWSAMIMapping": {
           "ap-south-1": {
              "HVM64": "ami-0912f71e06545ad88"
           },
           "ap-northeast-2": {
              "HVM64": "ami-0739c1a1119b2c1b9"
           },
           "eu-west-1": {
              "HVM64": "ami-0a63d30ebf9f9c11b"
           }
        }
     },
    "Resources":{
        "MongoInstacneIamRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    "ec2.amazonaws.com"
                                ]
                            },
                            "Action": [
                                "sts:AssumeRole"
                            ]
                        }
                    ]
                },
                "Path": "/",
                "Policies": [
                    {
                        "PolicyName": "MongoInstanceIamRolePolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                                "ec2:DescribeInstances",
                                                "ec2-instance-connect:SendSSHPublicKey",
                                                "ssm:StartSession"
                                        ],
                                    "Resource": "arn:aws:ec2:*:*:instance/*"
                                 }
                                ]
                                }
                    }
                ]
            }
        },
        "MongoInstacneIamProfile":{
            "Type":"AWS::IAM::InstanceProfile",
            "Properties":{
                "Path":"/",
                "Roles":[
                    {
                        "Ref":"MongoInstacneIamRole"
                    }
                ]
            }
        },
        "MongoInstancePrimary":{
            "Type":"AWS::EC2::Instance",
            "Properties":{
                "ImageId":{
               "Fn::FindInMap": [
                  "AWSAMIMapping",
                  { "Ref": "AWS::Region" },
                  "HVM64"
               ]
            },
                "InstanceType":"t2.micro",
                "IamInstanceProfile": {
                    "Ref": "MongoInstacneIamProfile"
                },
                "UserData":{
                    "Fn::Base64":{
                        "Fn::Join":[
                            "",
                            [
                                "#!/bin/bash",    
                                "sudo apt-get update -y",
                                "sudo yum install -y https://s3.amazonaws.com/ec2-downloads-windows/SSMAgent/latest/linux_amd64/amazon-ssm-agent.rpm",
                                "sudo systemctl start amazon-ssm-agent",
                                "sudo amazon-linux-extras install docker -y",
                                "sudo systemctl start docker",
                                "docker pull mongo",
                                "docker run -d --name mongodb -p 27017:27017 -v /data/db:/data/db --restart always -e MONGO_INITDB_ROOT_USERNAME=root -e MONGO_INITDB_ROOT_PASSWORD=secret mongo mongod --replSet rs0"
                            ]
                        ]
                    }
                },
                "NetworkInterfaces": [ {
                    "AssociatePublicIpAddress": "true",
                    "DeviceIndex": "0",
                    "GroupSet": [     {
                        "Fn::ImportValue": 
                            {
                                "Fn::Sub": "${RegionPrefix}-MongoInstanceSecurityGroupId"
                            }
                    }],
                    "SubnetId":  {
                        "Fn::ImportValue": 
                            {
                                "Fn::Sub": "${RegionPrefix}-public-subnet-1-id"
                            }
                    }
                  } ],
                "Tags":[
                    {
                        "Key":"Name",
                        "Value":"MongoInstancePrimary"
                    }
                ]
            }
        },
        "MongoInstanceSecondary01":{
            "Type":"AWS::EC2::Instance",
            "Properties":{
                "ImageId":{
               "Fn::FindInMap": [
                  "AWSAMIMapping",
                  { "Ref": "AWS::Region" },
                  "HVM64"
               ]
            },
                "InstanceType":"t2.micro",
                "IamInstanceProfile": {
                    "Ref": "MongoInstacneIamProfile"
                },
                "UserData":{
                    "Fn::Base64":{
                        "Fn::Join":[
                            "",
                            [
                                "#!/bin/bash",    
                                "sudo apt-get update -y",
                                "sudo yum install -y https://s3.amazonaws.com/ec2-downloads-windows/SSMAgent/latest/linux_amd64/amazon-ssm-agent.rpm",
                                "sudo systemctl start amazon-ssm-agent",
                                "sudo amazon-linux-extras install docker -y",
                                "sudo systemctl start docker",
                                "docker pull mongo",
                                "docker run -d --name mongodb -p 27017:27017 -v /data/db:/data/db --restart always -e MONGO_INITDB_ROOT_USERNAME=root -e MONGO_INITDB_ROOT_PASSWORD=secret mongo mongod --replSet rs0"
                            ]
                        ]
                    }
                },
                "NetworkInterfaces": [ {
                    "AssociatePublicIpAddress": "true",
                    "DeviceIndex": "0",
                    "GroupSet": [     {
                        "Fn::ImportValue": 
                            {
                                "Fn::Sub": "${RegionPrefix}-MongoInstanceSecurityGroupId"
                            }
                    }],
                    "SubnetId":  {
                        "Fn::ImportValue": 
                            {
                                "Fn::Sub": "${RegionPrefix}-public-subnet-2-id"
                            }
                    }
                  } ],
                "Tags":[
                    {
                        "Key":"Name",
                        "Value":"MongoInstanceSecondary01"
                    }
                ]
            }
        },
        "MongoInstanceSecondary02":{
            "Type":"AWS::EC2::Instance",
            "Properties":{
                "ImageId":{
               "Fn::FindInMap": [
                  "AWSAMIMapping",
                  { "Ref": "AWS::Region" },
                  "HVM64"
               ]
            },
                "InstanceType":"t2.micro",
                "IamInstanceProfile": {
                    "Ref": "MongoInstacneIamProfile"
                },
                "UserData":{
                    "Fn::Base64":{
                        "Fn::Join":[
                            "",
                            [
                                "#!/bin/bash",    
                                "sudo apt-get update -y",
                                "sudo yum install -y https://s3.amazonaws.com/ec2-downloads-windows/SSMAgent/latest/linux_amd64/amazon-ssm-agent.rpm",
                                "sudo systemctl start amazon-ssm-agent",
                                "sudo amazon-linux-extras install docker -y",
                                "sudo systemctl start docker",
                                "docker pull mongo",
                                "docker run -d --name mongodb -p 27017:27017 -v /data/db:/data/db --restart always -e MONGO_INITDB_ROOT_USERNAME=root -e MONGO_INITDB_ROOT_PASSWORD=secret mongo mongod --replSet rs0"
                            ]
                        ]
                    }
                },
                "NetworkInterfaces": [ {
                    "AssociatePublicIpAddress": "true",
                    "DeviceIndex": "0",
                    "GroupSet": [     {
                        "Fn::ImportValue": 
                            {
                                "Fn::Sub": "${RegionPrefix}-MongoInstanceSecurityGroupId"
                            }
                    }],
                    "SubnetId":  {
                        "Fn::ImportValue": 
                            {
                                "Fn::Sub": "${RegionPrefix}-public-subnet-3-id"
                            }
                    }
                  } ],
                "Tags":[
                    {
                        "Key":"Name",
                        "Value":"MongoInstanceSecondary02"
                    }
                ]
            }
        }
    }
}